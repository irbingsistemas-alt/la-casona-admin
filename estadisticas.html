<script>
  const entregados = JSON.parse(localStorage.getItem("pedidosEntregados")) || [];
  let filtrados = [];

  function fechaISO(fechaStr) {
    const f = new Date(fechaStr);
    return `${f.getFullYear()}-${String(f.getMonth() + 1).padStart(2, "0")}-${String(f.getDate()).padStart(2, "0")}`;
  }

  function aplicarFiltros() {
    const desde = document.getElementById("filtroDesde").value;
    const hasta = document.getElementById("filtroHasta").value;

    filtrados = entregados.filter(p => {
      const fechaPedido = fechaISO(p.fecha);
      return (!desde || fechaPedido >= desde) &&
             (!hasta || fechaPedido <= hasta);
    });

    generarEstadisticas(filtrados);
  }

  function limpiarFiltros() {
    document.getElementById("filtroDesde").value = "";
    document.getElementById("filtroHasta").value = "";
    generarEstadisticas(entregados);
  }

  function generarEstadisticas(pedidos) {
    const clientes = {};
    const platos = {};
    const pisos = {};
    const ingresos = {};

    pedidos.forEach(p => {
      clientes[p.cliente] = (clientes[p.cliente] || 0) + 1;
      p.items.forEach(i => {
        platos[i.nombre] = (platos[i.nombre] || 0) + i.cantidad;
      });
      pisos[p.piso] = (pisos[p.piso] || 0) + 1;
      const fecha = fechaISO(p.fecha);
      ingresos[fecha] = (ingresos[fecha] || 0) + p.total;
    });

    crearGrafico("clientesChart", clientes, "Clientes frecuentes", "#4e79a7");
    crearGrafico("platosChart", platos, "Platos más vendidos", "#f28e2b");
    crearGrafico("pisosChart", pisos, "Pisos con más entregas", "#76b7b2");
    crearGrafico("ingresosChart", ingresos, "Ingresos por día (CUP)", "#e15759");
  }

  function crearGrafico(id, datos, titulo, color) {
    const ctx = document.getElementById(id).getContext("2d");
    if (window[id] instanceof Chart) {
      window[id].destroy();
    }
    window[id] = new Chart(ctx, {
      type: "bar",
      data: {
        labels: Object.keys(datos),
        datasets: [{
          label: titulo,
          data: Object.values(datos),
          backgroundColor: color
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          title: { display: true, text: titulo }
        }
      }
    });
  }

  function exportarCSV() {
    const pedidos = filtrados.length ? filtrados : entregados;
    if (pedidos.length === 0) {
      alert("No hay datos para exportar.");
      return;
    }

    let csv = "Fecha,Cliente,Piso,Apto,Platos,Total\n";
    pedidos.forEach(p => {
      const platos = p.items.map(i => `${i.nombre} x${i.cantidad}`).join(" | ");
      const fecha = fechaISO(p.fecha);
      csv += `"${fecha}","${p.cliente}","${p.piso}","${p.apartamento}","${platos}","${p.total}"\n`;
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "estadisticas_pedidos.csv";
    link.style.display = "none";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  window.onload = () => generarEstadisticas(entregados);
</script>
